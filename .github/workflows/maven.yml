name: Java CI with Maven

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

env:
  IMAGE_NAME: ghcr.io/gowtham432/spring-boot-app-pipeline
  IMAGE_TAG: ${{ github.run_number }}

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Restore retry counter
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .retry-*
          key: retry-${{ github.ref_name }}-${{ github.run_number }}-v1
          restore-keys: |
            retry-${{ github.ref_name }}-
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build with Maven
        run: mvn clean install -DskipTests
      
      - name: Run Tests
        run: mvn test
        continue-on-error: true
      
      - name: SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=gowtham432_spring-boot-app-pipeline \
            -Dsonar.organization=gowtham432 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.branch.name=${{ github.ref_name }}
        continue-on-error: true
      
      - name: Wait for SonarCloud analysis
        run: sleep 30
      
      - name: Fetch SonarCloud issues for each file
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sleep 30
          
          mkdir -p sonar-file-reports
          
          JAVA_FILES=$(find src/main/java -name "*.java" -type f)
          
          echo "Found Java files:"
          echo "$JAVA_FILES"
          
          for JAVA_FILE in $JAVA_FILES; do
            RELATIVE_PATH="${JAVA_FILE#src/main/java/}"
            SAFE_FILENAME=$(echo "$RELATIVE_PATH" | tr '/' '_' | sed 's/.java$//')
            
            echo "Processing: $JAVA_FILE -> $SAFE_FILENAME"
            
            COMPONENT_KEY="gowtham432_spring-boot-app-pipeline:${JAVA_FILE}"
            
            curl -u $SONAR_TOKEN: \
              "https://sonarcloud.io/api/issues/search?componentKeys=${COMPONENT_KEY}&resolved=false&ps=500" \
              -o "sonar-file-reports/${SAFE_FILENAME}_issues.json" 2>/dev/null || echo "Failed to fetch issues for $JAVA_FILE"
            
            echo "Saved issues to: sonar-file-reports/${SAFE_FILENAME}_issues.json"
          done
        continue-on-error: true
      
      - name: Upload SonarCloud issues artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-issues
          path: sonar-file-reports/
      
      - name: Send issues to Zapier with retry logic
        if: always() && github.event_name != 'pull_request'
        id: zapier_sonar_files
        run: |
          BRANCH="${{ github.ref_name }}"
          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')
          MAX_RETRIES=5
          
          if [ ! -d "sonar-file-reports" ] || [ -z "$(ls -A sonar-file-reports/*_issues.json 2>/dev/null)" ]; then
            echo "No SonarCloud issues found to send"
            exit 0
          fi
          
          for ISSUES_FILE in sonar-file-reports/*_issues.json; do
            FILENAME=$(basename "$ISSUES_FILE" _issues.json)
            CACHE_FILE=".retry-sonar-${SAFE_BRANCH}-${FILENAME}"
            
            echo "=================================================="
            echo "Processing: $FILENAME"
            echo "=================================================="
            
            if [ -f $CACHE_FILE ]; then
              RETRIES=$(cat $CACHE_FILE)
            else
              RETRIES=0
            fi
            
            echo "Current retries for $FILENAME: $RETRIES"
            
            if [ "$RETRIES" -ge $MAX_RETRIES ]; then
              echo "Max retries ($MAX_RETRIES) reached for $FILENAME - skipping"
              continue
            fi
            
            ISSUE_COUNT=$(cat "$ISSUES_FILE" | jq '.issues | length' 2>/dev/null || echo "0")
            
            if [ "$ISSUE_COUNT" -eq 0 ] 2>/dev/null; then
              echo "No issues in $FILENAME - skipping"
              echo "0" > $CACHE_FILE
              continue
            fi
            
            JAVA_FILENAME=$(echo "$FILENAME" | tr '_' '/' | sed 's/$/.java/')
            JAVA_FULL_PATH="src/main/java/${JAVA_FILENAME}"
            
            if [ -f "$JAVA_FULL_PATH" ]; then
              FILE_SHA=$(git hash-object "$JAVA_FULL_PATH" 2>/dev/null || echo "unknown")
            else
              FILE_SHA="file_not_found"
              echo "WARNING: Source file not found: $JAVA_FULL_PATH"
            fi
            
            echo "Sending to Zapier: $JAVA_FILENAME (SHA: $FILE_SHA, Issues: $ISSUE_COUNT)"
            
            ISSUES_CONTENT=$(cat "$ISSUES_FILE")
            
            PAYLOAD=$(jq -n \
              --argjson issues "$ISSUES_CONTENT" \
              --arg filename "$JAVA_FILENAME" \
              --arg branch "$BRANCH" \
              --arg file_sha "$FILE_SHA" \
              '{
                sonar_issues: $issues,
                java_filename: $filename,
                branch: $branch,
                file_sha: $file_sha
              }'
            )
            
            HTTP_STATUS=$(curl -X POST "${{ secrets.ZAPIER_WEBHOOK_URL_SONAR }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              -w "%{http_code}" \
              -o /tmp/zapier_response.txt \
              -s)
            
            echo "Zapier response code: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
              echo "Successfully sent $FILENAME to Zapier"
              echo "0" > $CACHE_FILE
            else
              echo "Failed to send $FILENAME (HTTP $HTTP_STATUS)"
              NEW_RETRIES=$((RETRIES + 1))
              echo "$NEW_RETRIES" > $CACHE_FILE
              echo "Updated retry count to $NEW_RETRIES for $FILENAME"
              
              if [ "$NEW_RETRIES" -ge $MAX_RETRIES ]; then
                echo "WARNING: $FILENAME has reached max retries and will be skipped in future runs"
              fi
            fi
            
            sleep 2
          done
          
          echo "=================================================="
          echo "Finished processing all SonarCloud issues"
          echo "=================================================="
        continue-on-error: true
      
      - name: Save retry counters for SonarCloud files
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .retry-sonar-*
          key: retry-sonar-${{ github.ref_name }}-${{ github.run_number }}-v1