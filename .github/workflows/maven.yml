name: Java CI with Maven

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

env:
  IMAGE_NAME: ghcr.io/gowtham432/spring-boot-app-pipeline
  IMAGE_TAG: ${{ github.run_number }}

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build with Maven
        run: mvn clean install -DskipTests
      
      - name: Run Tests
        run: mvn test
        continue-on-error: true
      
      - name: SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=gowtham432_spring-boot-app-pipeline \
            -Dsonar.organization=gowtham432 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.branch.name=${{ github.ref_name }}
        continue-on-error: true
      
      - name: Wait for SonarCloud analysis
        run: sleep 30
      
      - name: Fetch SonarCloud issues for each file
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sleep 30
          
          mkdir -p sonar-file-reports
          
          JAVA_FILES=$(find src/main/java -name "*.java" -type f)
          
          echo "Found Java files:"
          echo "$JAVA_FILES"
          
          for JAVA_FILE in $JAVA_FILES; do
            RELATIVE_PATH="${JAVA_FILE#src/main/java/}"
            SAFE_FILENAME=$(echo "$RELATIVE_PATH" | tr '/' '_' | sed 's/.java$//')
            
            echo "Processing: $JAVA_FILE -> $SAFE_FILENAME"
            
            COMPONENT_KEY="gowtham432_spring-boot-app-pipeline:${JAVA_FILE}"
            
            curl -u $SONAR_TOKEN: \
              "https://sonarcloud.io/api/issues/search?componentKeys=${COMPONENT_KEY}&resolved=false&ps=500" \
              -o "sonar-file-reports/${SAFE_FILENAME}_issues.json" 2>/dev/null || echo "Failed to fetch issues for $JAVA_FILE"
            
            if [ -f "sonar-file-reports/${SAFE_FILENAME}_issues.json" ]; then
              ISSUE_COUNT=$(cat "sonar-file-reports/${SAFE_FILENAME}_issues.json" | jq '.issues | length' 2>/dev/null || echo "0")
              
              if [ "$ISSUE_COUNT" -gt 0 ]; then
                cat "sonar-file-reports/${SAFE_FILENAME}_issues.json" | jq -r '.issues[] | "[" + .severity + "] " + .type + " - " + .rule + "\nFile: " + .component + "\nLine: " + (.line // "N/A" | tostring) + "\nMessage: " + .message + "\n---"' > "sonar-file-reports/${SAFE_FILENAME}_issues.txt"
                echo "Created issues file with $ISSUE_COUNT issues: sonar-file-reports/${SAFE_FILENAME}_issues.txt"
              else
                echo "No issues found for $JAVA_FILE"
              fi
            fi
          done
        continue-on-error: true
      
      - name: Download previous artifacts to check retry count
        if: always() && github.event_name != 'pull_request'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: maven.yml
          branch: ${{ github.ref_name }}
          name: sonarcloud-issues-with-retry
          path: previous-sonar-reports
          if_no_artifact_found: ignore
        continue-on-error: true
      
      - name: Send issues to Zapier with retry logic (max 2 attempts)
        if: always() && github.event_name != 'pull_request'
        id: zapier_sonar_files
        run: |
          BRANCH="${{ github.ref_name }}"
          MAX_RETRIES=2
          
          if [ ! -d "sonar-file-reports" ] || [ -z "$(ls -A sonar-file-reports/*_issues.txt 2>/dev/null)" ]; then
            echo "No SonarCloud issues found to send"
            exit 0
          fi

          echo "=================================================="
          echo "RETRY STATUS SUMMARY"
          echo "=================================================="
          
          # Create output directory for files with retry count
          mkdir -p sonar-file-reports-with-retry
          
          for ISSUES_FILE in sonar-file-reports/*_issues.txt; do
            FILENAME=$(basename "$ISSUES_FILE" _issues.txt)
            JAVA_FILENAME=$(echo "$FILENAME" | tr '_' '/' | sed 's/$/.java/')
            JAVA_FULL_PATH="src/main/java/${JAVA_FILENAME}"
            JUST_FILE_NAME=$(basename "$JAVA_FULL_PATH")
            
            # Check if there's a previous artifact with retry count in filename
            CURRENT_RETRY=0
            if [ -d "previous-sonar-reports" ]; then
              # Look for files matching pattern: filename_retry_N_issues.txt
              PREV_FILE=$(ls previous-sonar-reports/${FILENAME}_retry_*_issues.txt 2>/dev/null | head -1)
              if [ -n "$PREV_FILE" ]; then
                # Extract retry count from filename
                CURRENT_RETRY=$(echo "$PREV_FILE" | sed -n 's/.*_retry_\([0-9]*\)_issues.txt/\1/p')
                echo "üìÑ $JUST_FILE_NAME: Found previous retry count = $CURRENT_RETRY"
              fi
            fi
            
            ISSUE_COUNT=$(grep -c "^\[" "$ISSUES_FILE" 2>/dev/null || echo "0")
            
            # If no issues, reset retry counter
            if [ "$ISSUE_COUNT" -eq 0 ]; then
              echo "‚úÖ $JUST_FILE_NAME: No issues - retry count = 0/$MAX_RETRIES"
              cp "$ISSUES_FILE" "sonar-file-reports-with-retry/${FILENAME}_retry_0_issues.txt"
              continue
            fi
            
            echo "üìÑ $JUST_FILE_NAME: Current retry count = $CURRENT_RETRY/$MAX_RETRIES (Issues: $ISSUE_COUNT)"
          done
          
          echo "=================================================="
          echo ""

          for ISSUES_FILE in sonar-file-reports/*_issues.txt; do
            FILENAME=$(basename "$ISSUES_FILE" _issues.txt)
            
            echo "=================================================="
            echo "Processing: $FILENAME"
            echo "=================================================="

            # Get previous retry count
            CURRENT_RETRY=0
            if [ -d "previous-sonar-reports" ]; then
              PREV_FILE=$(ls previous-sonar-reports/${FILENAME}_retry_*_issues.txt 2>/dev/null | head -1)
              if [ -n "$PREV_FILE" ]; then
                CURRENT_RETRY=$(echo "$PREV_FILE" | sed -n 's/.*_retry_\([0-9]*\)_issues.txt/\1/p')
              fi
            fi

            JAVA_FILENAME=$(echo "$FILENAME" | tr '_' '/' | sed 's/$/.java/')
            JAVA_FULL_PATH="src/main/java/${JAVA_FILENAME}"
            JUST_FILE_NAME=$(basename "$JAVA_FULL_PATH")

            echo "üìÑ File: $JUST_FILE_NAME | Retry count: $CURRENT_RETRY/$MAX_RETRIES"

            # Check if max retries reached
            if [ "$CURRENT_RETRY" -ge $MAX_RETRIES ]; then
              echo "‚õî Max retries ($MAX_RETRIES) reached for $JUST_FILE_NAME - skipping"
              # Still save the file with max retry count
              cp "$ISSUES_FILE" "sonar-file-reports-with-retry/${FILENAME}_retry_${CURRENT_RETRY}_issues.txt"
              continue
            fi

            if [ -f "$JAVA_FULL_PATH" ]; then
              FILE_SHA=$(git hash-object "$JAVA_FULL_PATH" 2>/dev/null || echo "unknown")
              FILE_CONTENT=$(cat "$JAVA_FULL_PATH")
            else
              FILE_SHA="file_not_found"
              FILE_CONTENT=""
              echo "‚ö†Ô∏è  WARNING: Source file not found: $JAVA_FULL_PATH"
            fi

            ISSUE_COUNT=$(grep -c "^\[" "$ISSUES_FILE" 2>/dev/null || echo "0")
            
            # If no issues, reset retry counter
            if [ "$ISSUE_COUNT" -eq 0 ]; then
              echo "‚úÖ No issues in $JUST_FILE_NAME - resetting retry counter"
              cp "$ISSUES_FILE" "sonar-file-reports-with-retry/${FILENAME}_retry_0_issues.txt"
              continue
            fi
            
            ISSUES_CONTENT=$(cat "$ISSUES_FILE")

            echo "üöÄ Sending to Zapier: $JUST_FILE_NAME (Issues: $ISSUE_COUNT, Attempt: $((CURRENT_RETRY + 1))/$MAX_RETRIES)"

            PAYLOAD=$(jq -n \
              --arg issues "$ISSUES_CONTENT" \
              --arg filename "$JAVA_FILENAME" \
              --arg full_path "$JAVA_FULL_PATH" \
              --arg file_name "$JUST_FILE_NAME" \
              --arg file_content "$FILE_CONTENT" \
              --arg branch "$BRANCH" \
              --arg file_sha "$FILE_SHA" \
              --arg retry_count "$CURRENT_RETRY" \
              '{
                sonar_issues: $issues,
                java_filename: $filename,
                java_full_path: $full_path,
                java_file_name: $file_name,
                java_file_content: $file_content,
                branch: $branch,
                file_sha: $file_sha,
                retry_count: $retry_count
              }'
            )

            HTTP_STATUS=$(curl -X POST "${{ secrets.ZAPIER_WEBHOOK_URL_SONAR }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              -w "%{http_code}" \
              -o /tmp/zapier_response.txt \
              -s)

            echo "üì° Zapier response code: $HTTP_STATUS"

            if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
              echo "‚úÖ Successfully sent $JUST_FILE_NAME to Zapier"
              # Save with retry count 0 (success)
              cp "$ISSUES_FILE" "sonar-file-reports-with-retry/${FILENAME}_retry_0_issues.txt"
              echo "üìÑ $JUST_FILE_NAME: Retry count reset to 0"
            else
              echo "‚ùå Failed to send $JUST_FILE_NAME (HTTP $HTTP_STATUS)"
              NEW_RETRY=$((CURRENT_RETRY + 1))
              # Save with incremented retry count
              cp "$ISSUES_FILE" "sonar-file-reports-with-retry/${FILENAME}_retry_${NEW_RETRY}_issues.txt"
              echo "üìÑ $JUST_FILE_NAME: Retry count updated to $NEW_RETRY/$MAX_RETRIES"
              
              if [ "$NEW_RETRY" -ge $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è  WARNING: $JUST_FILE_NAME has reached max retries ($MAX_RETRIES) and will be skipped in future runs"
              fi
            fi

            sleep 2
          done

          echo ""
          echo "=================================================="
          echo "FINAL RETRY STATUS"
          echo "=================================================="
          
          # Display final retry counts from saved filenames
          for RETRY_FILE in sonar-file-reports-with-retry/*_retry_*_issues.txt; do
            if [ -f "$RETRY_FILE" ]; then
              FILENAME=$(basename "$RETRY_FILE")
              RETRY_COUNT=$(echo "$FILENAME" | sed -n 's/.*_retry_\([0-9]*\)_issues.txt/\1/p')
              BASE_NAME=$(echo "$FILENAME" | sed 's/_retry_[0-9]*_issues.txt//')
              JAVA_FILENAME=$(echo "$BASE_NAME" | tr '_' '/' | sed 's/$/.java/')
              JUST_FILE_NAME=$(basename "src/main/java/${JAVA_FILENAME}")
              
              if [ "$RETRY_COUNT" -eq 0 ]; then
                echo "‚úÖ $JUST_FILE_NAME: Retry count = $RETRY_COUNT/$MAX_RETRIES"
              elif [ "$RETRY_COUNT" -ge $MAX_RETRIES ]; then
                echo "‚õî $JUST_FILE_NAME: Retry count = $RETRY_COUNT/$MAX_RETRIES (MAX REACHED)"
              else
                echo "‚ö†Ô∏è  $JUST_FILE_NAME: Retry count = $RETRY_COUNT/$MAX_RETRIES"
              fi
            fi
          done
          
          echo "=================================================="
          echo "Finished sending SonarCloud issues to Zapier"
          echo "=================================================="
      
      - name: Upload SonarCloud issues with retry count
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-issues-with-retry
          path: sonar-file-reports-with-retry/*_retry_*_issues.txt
          retention-days: 30