name: Java CI with Maven

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

env:
  IMAGE_NAME: ghcr.io/gowtham432/spring-boot-app-pipeline
  IMAGE_TAG: ${{ github.run_number }}

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Restore retry counter
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .retry-*
          key: retry-${{ github.ref_name }}-${{ github.run_number }}-v1
          restore-keys: |
            retry-${{ github.ref_name }}-
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Build with Maven
        run: mvn clean install -DskipTests
      
      - name: Run Tests
        run: mvn test
        continue-on-error: true
      
      - name: SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=gowtham432_spring-boot-app-pipeline \
            -Dsonar.organization=gowtham432 \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.branch.name=${{ github.ref_name }}
        continue-on-error: true
      
      - name: Wait for SonarCloud analysis
        run: sleep 30
      
      - name: Fetch SonarCloud issues for each file
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sleep 30
          
          mkdir -p sonar-file-reports
          
          JAVA_FILES=$(find src/main/java -name "*.java" -type f)
          
          echo "Found Java files:"
          echo "$JAVA_FILES"
          
          for JAVA_FILE in $JAVA_FILES; do
            RELATIVE_PATH="${JAVA_FILE#src/main/java/}"
            SAFE_FILENAME=$(echo "$RELATIVE_PATH" | tr '/' '_' | sed 's/.java$//')
            
            echo "Processing: $JAVA_FILE -> $SAFE_FILENAME"
            
            COMPONENT_KEY="gowtham432_spring-boot-app-pipeline:${JAVA_FILE}"
            
            curl -u $SONAR_TOKEN: \
              "https://sonarcloud.io/api/issues/search?componentKeys=${COMPONENT_KEY}&resolved=false&ps=500" \
              -o "sonar-file-reports/${SAFE_FILENAME}_issues.json" 2>/dev/null || echo "Failed to fetch issues for $JAVA_FILE"
            
            if [ -f "sonar-file-reports/${SAFE_FILENAME}_issues.json" ]; then
              ISSUE_COUNT=$(cat "sonar-file-reports/${SAFE_FILENAME}_issues.json" | jq '.issues | length' 2>/dev/null || echo "0")
              
              if [ "$ISSUE_COUNT" -gt 0 ]; then
                cat "sonar-file-reports/${SAFE_FILENAME}_issues.json" | jq -r '.issues[] | "[" + .severity + "] " + .type + " - " + .rule + "\nFile: " + .component + "\nLine: " + (.line // "N/A" | tostring) + "\nMessage: " + .message + "\n---"' > "sonar-file-reports/${SAFE_FILENAME}_issues.txt"
                echo "Created issues file with $ISSUE_COUNT issues: sonar-file-reports/${SAFE_FILENAME}_issues.txt"
              else
                echo "No issues found for $JAVA_FILE"
              fi
            fi
          done
        continue-on-error: true
      
      - name: Upload SonarCloud issues artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-issues
          path: sonar-file-reports/*_issues.txt
      
      - name: Send issues to Zapier (no retry logic)
        if: always() && github.event_name != 'pull_request'
        id: zapier_sonar_files
        run: |
          BRANCH="${{ github.ref_name }}"

          if [ ! -d "sonar-file-reports" ] || [ -z "$(ls -A sonar-file-reports/*_issues.txt 2>/dev/null)" ]; then
            echo "No SonarCloud issues found to send"
            exit 0
          fi

          for ISSUES_FILE in sonar-file-reports/*_issues.txt; do
            FILENAME=$(basename "$ISSUES_FILE" _issues.txt)

            echo "=================================================="
            echo "Processing: $FILENAME"
            echo "=================================================="

            JAVA_FILENAME=$(echo "$FILENAME" | tr '_' '/' | sed 's/$/.java/')
            JAVA_FULL_PATH="src/main/java/${JAVA_FILENAME}"
            JUST_FILE_NAME=$(basename "$JAVA_FULL_PATH")

            if [ -f "$JAVA_FULL_PATH" ]; then
              FILE_SHA=$(git hash-object "$JAVA_FULL_PATH" 2>/dev/null || echo "unknown")
              FILE_CONTENT=$(cat "$JAVA_FULL_PATH")
            else
              FILE_SHA="file_not_found"
              FILE_CONTENT=""
              echo "WARNING: Source file not found: $JAVA_FULL_PATH"
            fi

            ISSUE_COUNT=$(grep -c "^\[" "$ISSUES_FILE" 2>/dev/null || echo "0")
            ISSUES_CONTENT=$(cat "$ISSUES_FILE")

            echo "Sending to Zapier: $JUST_FILE_NAME (Issues: $ISSUE_COUNT)"

            PAYLOAD=$(jq -n \
              --arg issues "$ISSUES_CONTENT" \
              --arg filename "$JAVA_FILENAME" \
              --arg full_path "$JAVA_FULL_PATH" \
              --arg file_name "$JUST_FILE_NAME" \
              --arg file_content "$FILE_CONTENT" \
              --arg branch "$BRANCH" \
              --arg file_sha "$FILE_SHA" \
              '{
                sonar_issues: $issues,
                java_filename: $filename,
                java_full_path: $full_path,
                java_file_name: $file_name,
                java_file_content: $file_content,
                branch: $branch,
                file_sha: $file_sha
              }'
            )

            HTTP_STATUS=$(curl -X POST "${{ secrets.ZAPIER_WEBHOOK_URL_SONAR }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              -w "%{http_code}" \
              -o /tmp/zapier_response.txt \
              -s)

            echo "Zapier response code: $HTTP_STATUS"

            if [ "$HTTP_STATUS" -ne 200 ] && [ "$HTTP_STATUS" -ne 201 ]; then
              echo "ERROR: Failed to send $JUST_FILE_NAME (HTTP $HTTP_STATUS)"
            fi

            sleep 2
          done

          echo "=================================================="
          echo "Finished sending SonarCloud issues to Zapier"
          echo "=================================================="

      - name: Save retry counters for SonarCloud files
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .retry-sonar-*
          key: retry-sonar-${{ github.ref_name }}-${{ github.run_number }}-v1