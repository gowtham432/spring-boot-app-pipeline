name: Java CI with Maven
on:
  push:
    branches:
      - '**'  # Trigger on all branches
  pull_request:
    branches:
      - '**'  # Trigger on PRs to all branches
env:
  IMAGE_NAME:  ghcr.io/gowtham432/spring-boot-app-pipeline
  IMAGE_TAG: ${{ github.run_number }}
jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better SonarCloud analysis
    
    # Restore previous retry counter if exists
    - name: Restore retry counter
      id: cache-restore
      uses: actions/cache/restore@v4
      with:
        path: .retry-*
        key: retry-${{ github.ref_name }}-${{ github.run_number }}-v1
        restore-keys: |
          retry-${{ github.ref_name }}-
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
    
    - name: Verify project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo "=== POM.xml content ==="
        cat pom.xml
        echo "=== Source files ==="
        find src -name "*.java" -type f || echo "No Java files found"
    
    - name: Build with Maven
      run: mvn clean install -DskipTests
    
    - name: Run Tests
      run: mvn test
      continue-on-error: true
    
    - name: SonarCloud Scan (using Action)
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=gowtham432_spring-boot-app-pipeline
          -Dsonar.organization=gowtham432
          -Dsonar.sources=src/main/java
          -Dsonar.java.binaries=target/classes
          -Dsonar.tests=src/test/java
          -Dsonar.java.source=21
          -Dsonar.branch.name=${{ github.ref_name }}
      continue-on-error: true
    
    - name: Wait for SonarCloud analysis
      run: sleep 30
    
    - name: Generate comprehensive SonarCloud report
      if: always()
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        # Get project status
        curl -u $SONAR_TOKEN: \
          "https://sonarcloud.io/api/qualitygates/project_status?projectKey=gowtham432_spring-boot-app-pipeline" \
          > sonar-project-status.json
        
        # Get issues (bugs, vulnerabilities, code smells)
        curl -u $SONAR_TOKEN: \
          "https://sonarcloud.io/api/issues/search?componentKeys=gowtham432_spring-boot-app-pipeline&resolved=false&ps=500" \
          > sonar-issues.json
        
        # Get measures (metrics)
        curl -u $SONAR_TOKEN: \
          "https://sonarcloud.io/api/measures/component?component=gowtham432_spring-boot-app-pipeline&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,ncloc,sqale_index,reliability_rating,security_rating,sqale_rating,alert_status,quality_gate_details,new_bugs,new_vulnerabilities,new_code_smells,new_coverage,new_duplicated_lines_density,security_hotspots,comment_lines_density,complexity,cognitive_complexity" \
          > sonar-measures.json
        
        # Create comprehensive human-readable report
        cat > sonarcloud-full-report.txt << 'EOF'
        ================================================================================
                              SONARCLOUD ANALYSIS REPORT
        ================================================================================
        
        Project: gowtham432_spring-boot-app-pipeline
        Analysis Date: $(date)
        Report URL: https://sonarcloud.io/dashboard?id=gowtham432_spring-boot-app-pipeline
        
        ================================================================================
                                    QUALITY GATE STATUS
        ================================================================================
        EOF
        
        # Add quality gate status
        if [ -f sonar-project-status.json ]; then
          QG_STATUS=$(cat sonar-project-status.json | jq -r '.projectStatus.status' 2>/dev/null || echo "UNKNOWN")
          echo "" >> sonarcloud-full-report.txt
          echo "Status: $QG_STATUS" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
        fi
        
        cat >> sonarcloud-full-report.txt << 'EOF'
        ================================================================================
                                  OVERALL CODE METRICS
        ================================================================================
        EOF
        
        # Parse and display all metrics
        if [ -f sonar-measures.json ]; then
          echo "" >> sonarcloud-full-report.txt
          
          # Reliability (Bugs)
          BUGS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="bugs") | .value' 2>/dev/null || echo "0")
          RELIABILITY_RATING=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="reliability_rating") | .value' 2>/dev/null || echo "N/A")
          NEW_BUGS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="new_bugs") | .value' 2>/dev/null || echo "0")
          
          echo "RELIABILITY:" >> sonarcloud-full-report.txt
          echo "  - Bugs: $BUGS" >> sonarcloud-full-report.txt
          echo "  - New Bugs: $NEW_BUGS" >> sonarcloud-full-report.txt
          echo "  - Reliability Rating: $RELIABILITY_RATING (1=A, 5=E)" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          # Security (Vulnerabilities)
          VULNERABILITIES=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value' 2>/dev/null || echo "0")
          SECURITY_RATING=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="security_rating") | .value' 2>/dev/null || echo "N/A")
          SECURITY_HOTSPOTS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value' 2>/dev/null || echo "0")
          NEW_VULNERABILITIES=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="new_vulnerabilities") | .value' 2>/dev/null || echo "0")
          
          echo "SECURITY:" >> sonarcloud-full-report.txt
          echo "  - Vulnerabilities: $VULNERABILITIES" >> sonarcloud-full-report.txt
          echo "  - New Vulnerabilities: $NEW_VULNERABILITIES" >> sonarcloud-full-report.txt
          echo "  - Security Hotspots: $SECURITY_HOTSPOTS" >> sonarcloud-full-report.txt
          echo "  - Security Rating: $SECURITY_RATING (1=A, 5=E)" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          # Maintainability (Code Smells)
          CODE_SMELLS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="code_smells") | .value' 2>/dev/null || echo "0")
          MAINTAINABILITY_RATING=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="sqale_rating") | .value' 2>/dev/null || echo "N/A")
          TECH_DEBT=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="sqale_index") | .value' 2>/dev/null || echo "0")
          NEW_CODE_SMELLS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="new_code_smells") | .value' 2>/dev/null || echo "0")
          
          # Convert tech debt from minutes to hours/days
          TECH_DEBT_HOURS=$((TECH_DEBT / 60))
          TECH_DEBT_DAYS=$((TECH_DEBT / 480))
          
          echo "MAINTAINABILITY:" >> sonarcloud-full-report.txt
          echo "  - Code Smells: $CODE_SMELLS" >> sonarcloud-full-report.txt
          echo "  - New Code Smells: $NEW_CODE_SMELLS" >> sonarcloud-full-report.txt
          echo "  - Technical Debt: ${TECH_DEBT}min (~${TECH_DEBT_HOURS}h or ~${TECH_DEBT_DAYS}d)" >> sonarcloud-full-report.txt
          echo "  - Maintainability Rating: $MAINTAINABILITY_RATING (1=A, 5=E)" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          # Coverage
          COVERAGE=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="coverage") | .value' 2>/dev/null || echo "0")
          NEW_COVERAGE=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="new_coverage") | .value' 2>/dev/null || echo "0")
          
          echo "TEST COVERAGE:" >> sonarcloud-full-report.txt
          echo "  - Overall Coverage: ${COVERAGE}%" >> sonarcloud-full-report.txt
          echo "  - New Code Coverage: ${NEW_COVERAGE}%" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          # Duplications
          DUPLICATIONS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value' 2>/dev/null || echo "0")
          NEW_DUPLICATIONS=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="new_duplicated_lines_density") | .value' 2>/dev/null || echo "0")
          
          echo "CODE DUPLICATION:" >> sonarcloud-full-report.txt
          echo "  - Duplicated Lines: ${DUPLICATIONS}%" >> sonarcloud-full-report.txt
          echo "  - New Code Duplications: ${NEW_DUPLICATIONS}%" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          # Size & Complexity
          NCLOC=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="ncloc") | .value' 2>/dev/null || echo "0")
          COMMENT_DENSITY=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="comment_lines_density") | .value' 2>/dev/null || echo "0")
          COMPLEXITY=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="complexity") | .value' 2>/dev/null || echo "0")
          COGNITIVE_COMPLEXITY=$(cat sonar-measures.json | jq -r '.component.measures[] | select(.metric=="cognitive_complexity") | .value' 2>/dev/null || echo "0")
          
          echo "CODE SIZE & COMPLEXITY:" >> sonarcloud-full-report.txt
          echo "  - Lines of Code: $NCLOC" >> sonarcloud-full-report.txt
          echo "  - Comment Density: ${COMMENT_DENSITY}%" >> sonarcloud-full-report.txt
          echo "  - Cyclomatic Complexity: $COMPLEXITY" >> sonarcloud-full-report.txt
          echo "  - Cognitive Complexity: $COGNITIVE_COMPLEXITY" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
        fi
        
        cat >> sonarcloud-full-report.txt << 'EOF'
        ================================================================================
                                  DETAILED ISSUES BREAKDOWN
        ================================================================================
        EOF
        
        # Parse and display issues by severity
        if [ -f sonar-issues.json ]; then
          echo "" >> sonarcloud-full-report.txt
          
          BLOCKER=$(cat sonar-issues.json | jq '[.issues[] | select(.severity=="BLOCKER")] | length' 2>/dev/null || echo "0")
          CRITICAL=$(cat sonar-issues.json | jq '[.issues[] | select(.severity=="CRITICAL")] | length' 2>/dev/null || echo "0")
          MAJOR=$(cat sonar-issues.json | jq '[.issues[] | select(.severity=="MAJOR")] | length' 2>/dev/null || echo "0")
          MINOR=$(cat sonar-issues.json | jq '[.issues[] | select(.severity=="MINOR")] | length' 2>/dev/null || echo "0")
          INFO=$(cat sonar-issues.json | jq '[.issues[] | select(.severity=="INFO")] | length' 2>/dev/null || echo "0")
          
          echo "ISSUES BY SEVERITY:" >> sonarcloud-full-report.txt
          echo "  - Blocker: $BLOCKER" >> sonarcloud-full-report.txt
          echo "  - Critical: $CRITICAL" >> sonarcloud-full-report.txt
          echo "  - Major: $MAJOR" >> sonarcloud-full-report.txt
          echo "  - Minor: $MINOR" >> sonarcloud-full-report.txt
          echo "  - Info: $INFO" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          BUG_COUNT=$(cat sonar-issues.json | jq '[.issues[] | select(.type=="BUG")] | length' 2>/dev/null || echo "0")
          VULNERABILITY_COUNT=$(cat sonar-issues.json | jq '[.issues[] | select(.type=="VULNERABILITY")] | length' 2>/dev/null || echo "0")
          CODE_SMELL_COUNT=$(cat sonar-issues.json | jq '[.issues[] | select(.type=="CODE_SMELL")] | length' 2>/dev/null || echo "0")
          SECURITY_HOTSPOT_COUNT=$(cat sonar-issues.json | jq '[.issues[] | select(.type=="SECURITY_HOTSPOT")] | length' 2>/dev/null || echo "0")
          
          echo "ISSUES BY TYPE:" >> sonarcloud-full-report.txt
          echo "  - Bugs: $BUG_COUNT" >> sonarcloud-full-report.txt
          echo "  - Vulnerabilities: $VULNERABILITY_COUNT" >> sonarcloud-full-report.txt
          echo "  - Code Smells: $CODE_SMELL_COUNT" >> sonarcloud-full-report.txt
          echo "  - Security Hotspots: $SECURITY_HOTSPOT_COUNT" >> sonarcloud-full-report.txt
          echo "" >> sonarcloud-full-report.txt
          
          cat >> sonarcloud-full-report.txt << 'EOF'
        ================================================================================
                              TOP CRITICAL & BLOCKER ISSUES
        ================================================================================
        EOF
          echo "" >> sonarcloud-full-report.txt
          
          # List top critical/blocker issues
          cat sonar-issues.json | jq -r '.issues[] | select(.severity=="BLOCKER" or .severity=="CRITICAL") | "[\(.severity)] \(.type) - \(.rule)
        File: \(.component | split(":")[1] // .component)
        Line: \(.line // "N/A")
        Message: \(.message)
        ---"' 2>/dev/null >> sonarcloud-full-report.txt || echo "No critical or blocker issues found." >> sonarcloud-full-report.txt
          
          echo "" >> sonarcloud-full-report.txt
        fi
        
        cat >> sonarcloud-full-report.txt << 'EOF'
        ================================================================================
                                      RECOMMENDATIONS
        ================================================================================
        EOF
        echo "" >> sonarcloud-full-report.txt
        echo "1. Fix all BLOCKER and CRITICAL issues immediately" >> sonarcloud-full-report.txt
        echo "2. Aim for at least 80% code coverage on new code" >> sonarcloud-full-report.txt
        echo "3. Keep duplications below 3%" >> sonarcloud-full-report.txt
        echo "4. Maintain an 'A' rating for Reliability, Security, and Maintainability" >> sonarcloud-full-report.txt
        echo "5. Review and address security hotspots" >> sonarcloud-full-report.txt
        echo "" >> sonarcloud-full-report.txt
        echo "For detailed analysis and remediation guidance, visit:" >> sonarcloud-full-report.txt
        echo "https://sonarcloud.io/dashboard?id=gowtham432_spring-boot-app-pipeline" >> sonarcloud-full-report.txt
        echo "" >> sonarcloud-full-report.txt
        echo "================================================================================" >> sonarcloud-full-report.txt
        echo "                            END OF REPORT" >> sonarcloud-full-report.txt
        echo "================================================================================" >> sonarcloud-full-report.txt
      continue-on-error: true
    
    - name: Upload SonarCloud comprehensive report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sonarcloud-full-report
        path: sonarcloud-full-report.txt
    
    - name: Run Trivy filesystem scan on Maven dependencies (JSON output)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-results-fs.json'
        severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
        scanners: 'vuln,secret,misconfig,license'
      continue-on-error: true
    
    - name: Create Maven dependencies scan summary
      if: always()
      run: |
        if [ -f trivy-results-fs.json ]; then
  
          # Create CSV for Maven dependencies
          echo "Severity,CVE,Package,Installed Version,Fixed Version,File,Description" > trivy-maven-fs-vulnerabilities.csv
          cat trivy-results-fs.json | jq -r '.Results[]? | select(.Vulnerabilities != null) | .Target as $target | .Vulnerabilities[] | [.Severity, .VulnerabilityID, .PkgName, .InstalledVersion, (.FixedVersion // "No fix"), $target, (.Description // "N/A" | gsub(","; ";") | gsub("\n"; " ") | .[:100])] | @csv' >> trivy-maven-fs-vulnerabilities.csv
        fi
    
    - name: Upload Maven dependencies scan summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-maven-fs-vulnerabilities
        path: trivy-maven-fs-vulnerabilities.csv
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
    
    - name: Scan for vulnerabilities with Trivy for docker image (JSON output)
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: 'json'
        output: 'trivy-image-scan.json'
        severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
      continue-on-error: true
      
    - name: Create clean vulnerability summary
      if: always()
      run: |
        if [ -f trivy-image-scan.json ]; then     
          # Create CSV
          echo "Severity,CVE,Package,Installed Version,Fixed Version,Target,Description" > trivy-vulnerabilities-image.csv
          cat trivy-image-scan.json | jq -r '.Results[]? | select(.Vulnerabilities != null) | .Target as $target | .Vulnerabilities[] | [.Severity, .VulnerabilityID, .PkgName, .InstalledVersion, (.FixedVersion // "No fix"), $target, (.Description // "N/A" | gsub(","; ";") | gsub("\n"; " ") | .[:100])] | @csv' >> trivy-vulnerabilities-image.csv
        fi
        
    - name: outputs
      run: |
            pwd
            ls -lrt
            find . -name "pom.xml"
            cat ./pom.xml
            
   
    - name: Upload Trivy summary report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-vulnerabilities-image
        path: trivy-vulnerabilities-image.csv